version: 1
backend:
  phases:
    build:
      commands:
        - echo "=== AWS Identity Information ==="
        - aws sts get-caller-identity
        - echo "=== Checking IAM Role/User ==="
        - CALLER_ARN=$(aws sts get-caller-identity --query 'Arn' --output text)
        - echo "Caller ARN: $CALLER_ARN"
        - echo "=== Checking SSM Access ==="
        - aws ssm describe-parameters --max-results 1 || echo "No SSM access or no parameters found"
        - echo "=== Checking IAM Policy Simulation for SSM ==="
        - ROLE_NAME=$(echo $CALLER_ARN | grep -oP 'assumed-role/\K[^/]+' || echo "")
        - |
          if [ ! -z "$ROLE_NAME" ]; then
            echo "Role Name: $ROLE_NAME"
            aws iam get-role --role-name "$ROLE_NAME" --query 'Role.Arn' || echo "Cannot retrieve role details"
            aws iam list-attached-role-policies --role-name "$ROLE_NAME" || echo "Cannot list attached policies"
            aws iam list-role-policies --role-name "$ROLE_NAME" || echo "Cannot list inline policies"
          else
            echo "Not running as an assumed role, skipping policy checks"
          fi
        - echo "=== Installing dependencies ==="
        - npm ci --cache .npm --prefer-offline
        - echo "=== Deploying Amplify backend ==="
        - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
frontend:
  phases:
    preBuild:
      commands:
        - npm ci --cache .npm --prefer-offline
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - .npm/**/*
      - node_modules/**/*
